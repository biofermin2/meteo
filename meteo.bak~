#!/bin/sh
#|-*- mode:lisp -*-|#
#|
exec ros -Q -- $0 "$@"
|#
(progn ;;init forms
  (ros:ensure-asdf)
  #+quicklisp(ql:quickload '(:unio :assoc-utils :dexador :jonathan) :silent t) 
  )					; => (:UNIO :ASSOC-UTILS :DEXADOR :JONATHAN)

(defpackage :ros.script.meteo.3845973535
  (:use :cl :unio :dexador :jonathan :assoc-utils)
  (:shadow :delete :get)
  (:export :area-info :local-info))	; => #<PACKAGE "ROS.SCRIPT.METEO.3845973535">
(in-package :ros.script.meteo.3845973535) ; => #<PACKAGE "ROS.SCRIPT.METEO.3845973535">

(defconstant version "0.2.7")			     ; => VERSION
(defconstant url-top "https://www.jma.go.jp/bosai/") ; => URL-TOP

(defvar area-info)				       ; => AREA-INFO
(defvar local-data)				       ; => LOCAL-DATA
(defparameter area-ht (make-hash-table :test #'equal)) ; => AREA-HT


(defparameter w-code-plist
      '(100 â˜¼ 101 â˜¼â˜ 102 â˜¼â˜” 103 â˜¼â˜” 104 â˜¼â˜ƒ 105 â˜¼â˜ƒ 106 â˜¼â˜” 107 â˜¼â˜” 108 â˜¼â˜”  110 â˜¼â†’â˜ 111 â˜¼â†’â˜ 112 â˜¼â†’â˜” 113 â˜¼â†’â˜” 114 â˜¼â†’â˜” 115 â˜¼â†’â˜ƒ 116 â˜¼â†’â˜ƒ 117 â˜¼â†’â˜ƒ 118 â˜¼â†’â˜” 119 â˜¼â†’â˜” 120 â˜¼â˜” 121 â˜¼â˜” 122 â˜¼â†’â˜” 123 â˜¼ 124 â˜¼ 125 â˜¼â†’â˜” 126 â˜¼â†’â˜” 127 â˜¼â†’â˜” 128 â˜¼â†’â˜” 130 â˜¼ 131 â˜¼ 132 â˜¼â˜ 140 â˜¼â˜” 160 â˜¼â˜ƒ 170 â˜¼â˜ƒ 181 â˜¼â†’â˜ƒ
	200 â˜ 201 â˜â˜¼ 202 â˜â˜” 203 â˜â˜” 204 â˜â˜ƒ 205 à¼„â˜ƒ 206 â˜â˜” 207 â˜â˜” 208 â˜â˜” 209 â˜ 210 â˜â†’â˜¼ 211 â˜â†’â˜¼ 212 â˜â†’â˜” 213 â˜â†’â˜” 214 â˜â†’â˜” 215 â˜â†’â˜ƒ 216 â˜â†’â˜ƒ 217 â˜â†’â˜ƒ 218 â˜â†’â˜” 219 â˜â†’â˜” 228 â˜â†’â˜ƒ 229 â˜â†’â˜ƒ 230 â˜â†’â˜ƒ 231 â˜ 240 â˜â˜” 250 â˜â˜ƒ 260 â˜â˜ƒ 270 â˜â˜ƒ 281 â˜â†’â˜ƒ
	300 â˜” 301 â˜”â˜¼ 302 â˜”â˜ 303 â˜”â˜ƒ 304 â˜” 306 â˜” 308 à¼„â˜” 309 â˜”â˜ƒ 311 â˜”â†’â˜¼ 313 â˜”â†’â˜ 314 â˜”â†’â˜ƒ 315 â˜”â†’â˜ƒ 316 â˜”â†’â˜¼ 317 â˜”â†’â˜ 320 â˜”â†’â˜¼ 321 â˜”â†’â˜ 322 â˜”â˜ƒ 323 â˜”â†’â˜¼ 324 â˜”â†’â˜¼ 325 â˜”â†’â˜¼ 326 â˜”â†’â˜ƒ 327 â˜”â†’â˜ƒ 328 â˜” 329 â˜” 340 â˜ƒ 350 â˜” 361 â˜”â†’â˜¼ 371 â˜”â†’â˜
	400 â˜ƒ 401 â˜ƒâ˜¼ 402 â˜ƒâ˜ 403 â˜ƒâ˜” 405 â˜ƒ 406 à¼„â˜ƒ 407 à¼„â˜ƒ 409 â˜ƒâ˜” 411 â˜ƒâ†’â˜¼ 413 â˜ƒâ†’â˜ 414 â˜ƒâ†’â˜” 420 â˜ƒâ†’â˜¼ 421 â˜ƒâ†’â˜ 422 â˜ƒâ†’â˜” 423 â˜ƒâ†’â˜” 425 â˜ƒ 426 â˜ƒ 427 â˜ƒ 450 â˜ƒ
	500 â­ðŸŒ™ 501 â­ðŸŒ™â˜ 502 â­ðŸŒ™â˜” 504 â­ðŸŒ™â˜ƒ 510 â­ðŸŒ™â†’â˜ 512 â­ðŸŒ™â†’â˜” 515 â­ðŸŒ™â†’â˜ƒ
	601 â˜â­ðŸŒ™ 610 â˜â†’â­ðŸŒ™
	701 â˜”â­ðŸŒ™ 711 â˜”â†’â­ðŸŒ™
	801 â˜ƒâ­ðŸŒ™ 811 â˜ƒâ†’â­ðŸŒ™))		; => W-CODE-PLIST

(defparameter prefs '(åŒ—æµ·é“ é’æ£®çœŒ å²©æ‰‹çœŒ å®®åŸŽçœŒ ç§‹ç”°çœŒ
			  å±±å½¢çœŒ ç¦å³¶çœŒ èŒ¨åŸŽçœŒ æ ƒæœ¨çœŒ ç¾¤é¦¬çœŒ
			  åŸ¼çŽ‰çœŒ åƒè‘‰çœŒ æ±äº¬éƒ½ ç¥žå¥ˆå· æ–°æ½ŸçœŒ
			  å¯Œå±±çœŒ çŸ³å·çœŒ ç¦äº•çœŒ å±±æ¢¨çœŒ é•·é‡ŽçœŒ
			  å²é˜œçœŒ é™å²¡çœŒ æ„›çŸ¥çœŒ ä¸‰é‡çœŒ æ»‹è³€çœŒ
			  äº¬éƒ½åºœ å¤§é˜ªåºœ å…µåº«çœŒ å¥ˆè‰¯çœŒ å’Œæ­Œå±±çœŒ
			  é³¥å–çœŒ å³¶æ ¹çœŒ å²¡å±±çœŒ åºƒå³¶çœŒ å±±å£çœŒ
			  å¾³å³¶çœŒ é¦™å·çœŒ æ„›åª›çœŒ é«˜çŸ¥çœŒ ç¦å²¡çœŒ
			  ä½è³€çœŒ é•·å´ŽçœŒ ç†Šæœ¬çœŒ å¤§åˆ†çœŒ å®®å´ŽçœŒ
		      é¹¿å…å³¶çœŒ æ²–ç¸„çœŒ))	; => PREFS



(defun show-pref-name (n)
  (nth (1- n) prefs))			; => SHOW-PREF-NAME


(defun pref-num (code)
  (truncate (/ code 10000.0)))		; => PREF-NUM

(defun code->name (code)
  (show-pref-name (pref-num code)))	; => CODE->NAME

(defun prompt-read (prompt)
  "from practical common lisp"
  (format *query-io* "~a: " prompt)
  (force-output *query-io*)
  (read-line *query-io*))		; => PROMPT-READ


(defun system (control-string &rest args)
  "Interpolate ARGS into CONTROL-STRING as if by FORMAT, and
synchronously execute the result using a Bourne-compatible shell, with
output to *verbose-out*.  Returns the shell's exit code."
  (let ((command (apply #'format nil control-string args)))
    (format t "; $ ~A~%" command)
    #+sbcl
    (sb-impl::process-exit-code
     (sb-ext:run-program
      "/usr/bin/zsh"
      (list  "-c" command)
      :input nil :output *standard-output*))
    #+(or cmu scl)
    (ext:process-exit-code
     (ext:run-program
      "/bin/sh"
      (list  "-c" command)
      :input nil :output *verbose-out*))
    #+clisp             ;XXX not exactly *verbose-out*, I know
    (ext:run-shell-command  command :output :terminal :wait t)
    ))					; => SYSTEM


(defun put-ht (k v ht)
  (setf (gethash k ht) v))		; => PUT-HT

(defun print-ht (ht)
  "ãƒãƒƒã‚·ãƒ¥è¡¨ã®å‡ºåŠ›é–¢æ•°"
  (maphash #'(lambda (k v) (print (list k v))) ht)) ; => PRINT-HT

(defun puts-ht (lst ht)
  (loop :for i :in lst
	:count i :into cnt
	:do (put-ht cnt i ht)))		; => PUTS-HT


(defun pp-ht (lst ht)
  "puts-htã®å‡¦ç†ä¸­ã«çœŒåã‚’è¿½åŠ å‡ºæ¥ã‚‹ã‚ˆã†ã«å°‚ç”¨åŠ å·¥ã—ãŸé–¢æ•°[2022-07-02 15:22:16]ä¿®æ­£"
  (loop :for i :in lst
       :count i :into cnt
     :do (put-ht cnt (nconc `(pref-name ,(code->name (getf i '|parent|))) i) ht))) ; => PP-HT


(defun restart-err ()
  (restart-case (error "There is no information applicable to the specified area.")
    (use-value (value) 
      :report "Use a value."
      :interactive (lambda () 
		     (list (read)))
      value)
    (ignore ()
      :report "Ignore."
      nil)))				; => RESTART-ERR

(defun select-value (ht &aux (cnt (hash-table-count ht)))
  (cond ((= cnt 0) (restart-err))
	(t (loop :for k :being :the hash-keys :in ht
		   :using (hash-value v)
		 :do (format *query-io* "~d: ~(~s~)~%" k v)
		 :finally (format *query-io* "select a number[1-~d]" cnt))))) ; => SELECT-VALUE

(defun upper-codes (muni)
  "fix [2022-07-02 17:50:58]put only Municipality as argument"
  (let* ((url-bot "common/const/area.json")
	 (area-json (parse (remove #\, (dex:get (format nil "~a~a" url-top url-bot))))))
    (setf area-info (seek muni area-json :exact t :opt :preserve :str nil))
    (pp-ht area-info area-ht))
  (let* ((info (if (= 1 (hash-table-count area-ht))
		   (car area-info)
		   (gethash
		    (parse-integer (prompt-read (select-value area-ht)) :junk-allowed t)
		    area-ht)))
	 (code (getf info '|parent|))
	 (prefs-code (* 1000 (truncate (/ code 1000))))
	 (local-code (* 10 (truncate (/ code 10)))))
    (setf area-info info)
    (cond ((or (= prefs-code 460000)
	       (= prefs-code 014000)) (incf prefs-code 100))
	  ((= prefs-code 011000) (setq local-code prefs-code))) 
    (values (format nil "~6,'0d" prefs-code)
	    (format nil "~6,'0d" local-code)))) ; => UPPER-CODES


(defun code->sym (code)
  "change from weather code to symbol mark"
  (getf w-code-plist code))		; => CODE->SYM

(defun local-info (muni)
  "fix[2022-07-02 17:50:46]"
  (let ((url-mid "forecast/data/forecast/"))
    (multiple-value-bind (prefs local)
	(upper-codes muni)
      (let ((json-data (parse (dex:get (format nil "~a~a~a.json" url-top url-mid prefs)))))
	(setf local-data
	      (seek local json-data :skin 1 :str nil :opt :preserve)))
      (let ((d (apply #'append local-data)))
	(format t "~a~%" (reverse (pairlis (mapcar #'code->sym (getf d '|weatherCodes|))
				 (getf d '|weathers|)))))))) ; => LOCAL-INFO

;; weather map

(defun today ()
  "ç¾åœ¨æ—¥ä»˜ã®å–å¾—"
  (multiple-value-bind (s m h dd mm yy)
      (decode-universal-time (get-universal-time))
    (declare (ignore s m h))
    (format nil "~4,'0D-~2,'0D-~2,'0D" yy mm dd))) ; => TODAY

(defmacro set-readtable (opt &body body)
  "opt:upcase,downcase,preserve,invert"
  `(let ((*readtable* (copy-readtable nil)))
     (setf (readtable-case *readtable*) ,opt)
     ,@body))				; => SET-READTABLE

(defun map-url (n)
  ;; "fix[2022-07-02 18:24:14]"
  ;; "ãƒ‡ãƒ¼ã‚¿å–å¾—å…ƒã®urlã®ç”Ÿæˆ"
  (let* ((url-mid "weather_map/data/png/")
	 (url-bot "weather_map/data/list.json")
	 (list-json (parse (dex:get (format nil "~a~a" url-top url-bot)) :as :alist))
	 (now-lst (seek "now" list-json :str nil :opt :preserve)))
    (format nil "~a~a~a"
	    url-top
	    url-mid
	    (car (last (cond ((= n 1) (first now-lst))
			     ((= n 2) (second now-lst))
			     ((= n 3) (third now-lst))
			     ((= n 4) (fourth now-lst))
			     (t (error "put number 1ã€œ4")))))))) ; => MAP-URL


(defun download-file (uri &optional (filename))
  (with-open-file (out filename :direction :output
				:if-exists :supersede
				:element-type '(unsigned-byte 8))
    (with-open-stream (input (dex:get uri :want-stream t :connect-timeout nil))
      (loop :for b := (read-byte input nil -1)
	    :until (minusp b)
	    :do (write-byte b out)))))	; => DOWNLOAD-FILE

(defun map-name (n)
  "å‡ºåŠ›ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«åã®ç”Ÿæˆ"
  (let ((prefix
	 (cond ((string= n "1") "asia-pacific-mono")
	       ((string= n "2") "asia-pacific-color")
	       ((string= n "3") "around-Japan-mono")
	       ((string= n "4") "around-Japan-color"))))
    (format nil "~a-~a.png" prefix (today)))) ; => MAP-NAME

(defun show-weather-map (n)
  (let ((out-file (map-name n)))
    (download-file (map-url (parse-integer n)) out-file)
    (system (format nil "xdg-open ~a~a" (truename "./") out-file)))) ; => SHOW-WEATHER-MAP

;; Satellite image

(defun center-pt (z)
  (expt 2 (+ z 7)))			; => CENTER-PT

(defun total-px (z)
  (* (center-pt z) 2))			; => TOTAL-PX

(defun px/deg (z)
  (/ (total-px z) 360))			; => PX/DEG

(defun lon->x (lon z)
  (floor (/ (+ (center-pt z) (* lon (px/deg z)) 0.5) 256))) ; => LON->X

(defun px/rad (z)
  (/ (total-px z) (* 2 pi)))		; => PX/RAD

(defun siny (lat)
  (min (max (sin (* lat (/ pi 180))) -0.9999) 0.9999)) ; => SINY

(defun lat->y (lat z)
  (floor
   (/ (+ 0.5 (- (center-pt z)
		(* 0.5 (log (/ (+ 1 (siny lat))
			       (- 1 (siny lat))))
		   (px/rad z)))) 256)))	; => LAT->Y

(defun rm-last-char (str)
  (subseq str 0 (1- (length str))))	; => RM-LAST-CHAR


(defun lon/lat (muni)
  "fix[2022-07-02 18:47:58] ã“ã“ã§ç·¯åº¦çµŒåº¦ã‚’å‡ºåŠ›ã—ã¦ã„ã‚‹!"
  (let* ((name (rm-last-char muni))
	 (url-mid "amedas/const/")
	 (amedas-data (parse (dex:get (format nil "~a~a~a" url-top url-mid "amedastable.json"))))
	 (local-amedas (car (seek name amedas-data :str nil))))
    (values (car (getf local-amedas 'lon))
	    (car (getf local-amedas 'lat))))) ; => LON/LAT


(defun show-sat-img (muni n)
  "zã¯zoomãƒ¬ãƒ™ãƒ«6å›ºå®š"
  (let (prefix
	b/p
	(num (parse-integer n)))
    (cond ((= num 1) (setq prefix "infrared"
			   b/p "B13/TBB")) ;èµ¤å¤–ç”»åƒ
	  ((= num 2) (setq prefix "visible"
			   b/p "B03/ALBD")) ;å¯è¦–ç”»åƒ
	  ((= num 3) (setq prefix "water-vapor"
			   b/p "B08/TBB")) ;æ°´è’¸æ°—ç”»åƒ
	  ((= num 4) (setq prefix "truecolor"
			   b/p "REP/ETC")) ;true colorå†ç¾ç”»åƒ
	  ((= num 5) (setq prefix "cloud-top"
			   b/p "SND/ETC")) ;é›²é ‚å¼·èª¿ç”»åƒ
	  (t (error "select number [1-5]")))
    (multiple-value-bind (lon lat)
	(lon/lat muni)
      (let* ((url-mid "himawari/data/satimg/")
	     (latest-time
	       (car (last (parse (dex:get
				  (format nil "~a~atargetTimes_jp.json" url-top url-mid))))))
	     (z 6)
	     (x (lon->x lon z))
	     (y (lat->y lat z))
	     (out-file (format nil "~a-~a-~a.jpg" prefix (today) muni)))
	(multiple-value-bind (bt vt)
	    (values (getf latest-time :|basetime|)
		    (getf latest-time :|validtime|))
	  (download-file (format nil "~a~a~a/jp/~a/~a/~a/~a/~a.jpg"
				 url-top url-mid bt vt b/p z x y)
			 out-file)
	  (system (format nil "xdg-open ~a~a" (truename "./") out-file))))))) ; => SHOW-SAT-IMG

;; now cast
;; https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N1.json
;; https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N2.json
;; https://www.jma.go.jp/bosai/himawari/data/nowc/{basetime}/none/{validtime}/surf/hrpns/{z}/{x}/{y}.png
;; åœ°å›³ã®ç¨®é¡ž
;; æ¨™æº–åœ°å›³ std 5-18
;; æ·¡è‰²åœ°å›³ pale 5-18
;; English english 5-11
;; æ•°å€¤åœ°å›³25000ï¼ˆåœŸåœ°æ¡ä»¶ï¼‰ lcm25k_2012 10-16
;; åœŸåœ°æ¡ä»¶å›³ï¼ˆåˆæœŸæ•´å‚™ç‰ˆï¼‰ lcm25k 14-16
;; æ²¿å²¸æµ·åŸŸåœŸåœ°æ¡ä»¶å›³ ccm1 ï¼ˆå¹³æˆå…ƒå¹´ä»¥é™ï¼‰ ccm2 ï¼ˆæ˜­å’Œ63å¹´ä»¥å‰ï¼‰ 14-16
;; ç™½åœ°å›³ blank 5-14
;; x å†™çœŸ seamlessphoto 2-18
;; ä¸–ç•Œè¡›æ˜Ÿãƒ¢ã‚¶ã‚¤ã‚¯ç”»åƒ modis 2-8
;; x å…¨å›½ãƒ©ãƒ³ãƒ‰ã‚µãƒƒãƒˆãƒ¢ã‚¶ã‚¤ã‚¯ç”»åƒ lndst 2-15
;; è‰²åˆ¥æ¨™é«˜å›³ relief 5-15
;; ã‚¢ãƒŠã‚°ãƒªãƒ• anaglyphmap_color anaglyphmap_gray 2-16
;; é™°å½±èµ·ä¼å›³ hillshademap 2-16
;; å‚¾æ–œé‡å›³ slopemap 3-15
;; å…¨å›½å‚¾æ–œé‡åŒºåˆ†å›³ï¼ˆé›ªå´©é–¢é€£ï¼‰ slopezone1map 3-15


(defun show-nowcast (muni n &optional (map-type "relief"))
  "z (ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«) ã¯ 4ï½ž10"
  (multiple-value-bind (lon lat)
      (lon/lat muni)
    (let* ((url-mid "jmatile/data/nowc/")
	   (latest-time
	     (car (parse (dex:get
			  (format nil "~a~a~a" url-top url-mid "targetTimes_N1.json"))
			 :as :alist)))
	   (gsi-url "https://cyberjapandata.gsi.go.jp/xyz/")
	   (z (parse-integer n))
	   (x (lon->x lon z))
	   (y (lat->y lat z))
	   nowcast-layer
	   map-layer
	   (nowcast-file (format nil "~a~a" (truename "./") "nowcast.png"))
	   (map-file (format nil "~a~a" (truename "./") "map.png"))
	   (out-file (format nil "nowcast-~a-~a-~a.png" (today) muni z)))
      (multiple-value-bind (bt vt)
	  (values (aget latest-time "basetime")
		  (aget latest-time "validtime"))
	(setf nowcast-layer (format nil "~a~a~a/none/~a/surf/hrpns/~a/~a/~a.png"
				    url-top url-mid bt vt z x y))
	(setf map-layer (format nil "~a~a/~a/~a/~a.png" gsi-url map-type z x y))
	(download-file nowcast-layer nowcast-file)
	(download-file map-layer map-file)
	(system (format nil "~a ~a ~a ~a" "composite -compose over" nowcast-file map-file out-file))
	(system (format nil "xdg-open ~a~a" (truename "./") out-file)))))) ; => SHOW-NOWCAST


(defconstant print-help
  "this script pickups these 3 days weather forcast data from Japan Meteorological Agency,
and print it on your command line. ;=> https://github.com/biofermin2/meteo

usage1: $ meteo <your municipality in Chinese character>

usage2: $ meteo <option>

option:
  -v, --version            print version
  -h, --help               print help
  -m <number:1ã€œ4>, --map  download weather map file
     1: asia-pacific region monochrome
     2: asia-pacific region color
     3: around Japan monochrome
     4: around Japan color

usage3: $ meteo <municipality> <sub option>

sub option:
  -d, --detail                    print detail info
  -a, --area-info                 print area info
  -s <number:1ã€œ5>, --satellite   show satellite image
     1:infrared image
     2:visible image
     3:water-vapor image
     4:truecolor image
     5:cloud-top image
  -n <number:5ã€œ8>, --nowcast     show nowcast image
    number means zoom level. recommend is 6.

")					; => PRINT-HELP

(defun main (&rest argv)
  (declare (ignorable argv))
  (let ((1st (first argv))
	(2nd (second argv))
	(3rd (third argv))
	(4th (fourth argv)))
    (cond
      ((or (string= 1st "--version")
	   (string= 1st "-v"))
       (format t "~a~%" version))
      ((or (string= 1st "--help")
	   (string= 1st "-h"))
       (format t print-help))
      ((or (string= 1st "-m")
	   (string= 1st "--map"))
       (show-weather-map 2nd))
      (t (local-info 1st)
	 (cond ((or (string= 2nd "-d")
		    (string= 2nd "--detail"))
		(format t "~(~s~)" local-data))
	       ((or (string= 2nd "-a")
		    (string= 2nd "--area-info"))
		(format t "~(~s~)" area-info))
	       ((or (string= 2nd "-s")
		    (string= 2nd "--satellite"))
		(show-sat-img 1st 3rd))
	       ((or (string= 2nd "-n")
		    (string= 2nd "--nowcast"))
		(if 4th
		    (show-nowcast 1st 3rd 4th)
		    (show-nowcast 1st 3rd)))))))) ; => MAIN

;;; vim: set ft=lisp lisp:
